<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Galaxy Patrol ‚Äî Neon Hyperdrive Edition</title>
<style>
  :root{
    --bg:#0a0f22;
    --panel:#0c122acc;
    --panel-strong:#0d1437e6;
    --text:#e7f1ff;
    --muted:#9fb0d8;
    --accent:#6fe1ff;
    --accent-2:#9aff7a;
    --hot:#ff80e8;
    --danger:#ff6b6b;
    --edge:#3b4fa0;
    --edge2:#00e1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1600px 900px at 50% 10%,#131a3f,#0b122c 55%,#060a18)}
  body{color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  #game-container{position:relative;display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;overflow:hidden}

  /* Ensure HTML hidden always hides, regardless of CSS display rules */
  [hidden]{display:none !important;}

  /* Canvas under the UI */
  canvas#game{display:block;image-rendering:crisp-edges;image-rendering:pixelated;outline:none;position:relative;z-index:1;background:transparent}

  /* UI above canvas, fully clickable */
  #ui{position:absolute;inset:0;z-index:2;pointer-events:auto}

  /* Futuristic panel w/ cut corners and animated edge */
  .panel{
    position:absolute;inset:auto 0 0 0;margin:auto;max-width:min(760px,92vw);
    color:var(--text);background:linear-gradient(180deg,#0b1331ee,#0a1028dd);
    border:1px solid #2b3577;border-radius:14px;box-shadow:0 28px 120px #000b;
    padding:18px;opacity:0;transform:translateY(18px) scale(.985);transition:.28s ease;pointer-events:none;
    clip-path:polygon(14px 0, 100% 0, 100% calc(100% - 14px), calc(100% - 14px) 100%, 0 100%, 0 14px);
  }
  .panel::before{
    content:"";position:absolute;inset:-1px;pointer-events:none;border-radius:16px;
    background:conic-gradient(from 0deg at 50% 50%, #00b9ff, #8bffbf, #ff80e8, #00b9ff);
    filter:blur(10px) saturate(120%);opacity:.12;transition:.2s ease;
    clip-path:inherit;
  }
  .panel.visible{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
  .panel h1{margin:.2rem 0 .6rem;font-size:28px;letter-spacing:.5px}
  .panel h2{margin:.2rem 0 .4rem;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 240px;min-width:200px}

  /* Neon buttons */
  .btn{
    appearance:none;border:1px solid #2a3a69;background:
      linear-gradient(180deg,#1a2350,#121944);
    color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:700;
    letter-spacing:.3px;display:inline-flex;gap:8px;align-items:center;justify-content:center;
    box-shadow:inset 0 0 0 1px #22306a, 0 8px 22px #000a;
  }
  .btn:hover{filter:brightness(1.08)}
  .btn.big{width:100%;font-size:16px;padding:14px}
  .btn.ghost{background:#0b143099}
  .btn.red{border-color:#763242;background:linear-gradient(#4e1724,#2a0d17)}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  label{display:block;margin:.4rem 0 .2rem;color:var(--muted)}
  input[type="range"]{width:100%}
  select,input[type="text"]{width:100%;padding:10px;border-radius:10px;background:#0b1330;border:1px solid #28346d;color:var(--text)}
  .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px dashed #2b355b;border-radius:10px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0c1230;padding:4px 8px;border-radius:8px;border:1px solid #2b355b}
  .muted{color:var(--muted)}
  .note{font-size:13px;color:#b8c5ff}
  .center{display:flex;gap:10px;align-items:center;justify-content:center}
  .split{display:flex;gap:14px;flex-wrap:wrap}
  .split > *{flex:1 1 260px}
  .hr{height:1px;background:#263269;margin:10px 0}
  .badge{display:inline-block;padding:2px 8px;border:1px solid #2b355b;border-radius:999px;font-size:12px;color:#c7d3ff}
  .list{list-style:none;margin:0;padding:0}
  .list li{display:flex;justify-content:space-between;padding:8px 10px;border-bottom:1px dashed #2b355b}
  .right{margin-left:auto}

  /* Overlays */
  #pauseOverlay,#gameOverOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .overlay-card{pointer-events:auto;max-width:min(560px,92vw);padding:18px;background:var(--panel-strong);border:1px solid #29315c;border-radius:14px;box-shadow:0 20px 80px #000c}
  .overlay-card h2{margin:.2rem 0 .6rem}
  .overlay-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

  /* Boot tooltip */
  #boot{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  #boot .overlay-card{text-align:center}

  /* Mobile controls */
  #mobile{position:absolute;inset:auto 0 10px 0;display:none;justify-content:space-between;align-items:flex-end;gap:10px;padding:6px}
  .thumb{touch-action:none;border:1px solid #2b355b;background:#0e1433aa;color:#cde7ff;border-radius:12px;padding:12px 14px;min-width:64px;text-align:center;user-select:none}
  .thumb.small{min-width:58px}
  .thumb:active{filter:brightness(1.15)}
  @media (hover:none),(pointer:coarse){
    #mobile{display:flex}
    .panel{max-width:92vw}
  }

  /* Tiny HUD toasts */
  #tinyToasts{position:absolute;left:50%;top:64px;transform:translateX(-50%);display:flex;flex-direction:column;gap:6px;align-items:center;pointer-events:none}
  .toast{padding:6px 10px;border-radius:999px;background:#0f1b44cc;border:1px solid #2b355b;color:#dce5ff;font-size:13px;opacity:0;transform:translateY(-6px);transition:opacity .3s, transform .3s}
  .toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div id="game-container">
  <canvas id="game" tabindex="0" aria-label="Galaxy Patrol game canvas"></canvas>

  <!-- UI LAYER -->
  <div id="ui" aria-live="polite">

    <!-- Boot (unlock audio) -->
    <div id="boot">
      <div class="overlay-card">
        <h2>Galaxy Patrol ‚Äî Hyperdrive</h2>
        <p class="muted">Click / Tap to initialize audio &amp; continue.</p>
        <div class="center" style="margin-top:8px">
          <button class="btn big" id="bootBtn">Start</button>
        </div>
        <p class="note" style="margin-top:10px">Move: ‚Üê ‚Üí ¬∑ Fire: Space ¬∑ Bomb: Shift ¬∑ <strong>Special: E</strong> (Hyperdrive) ¬∑ <strong>Dash: Q</strong> ¬∑ Pause: Esc.</p>
      </div>
    </div>

    <!-- Main Menu -->
    <div id="menu" class="panel">
      <h1>Galaxy Patrol <span class="badge">v1.1.0</span></h1>
      <div class="split">
        <div>
          <button class="btn big" id="newGameBtn">‚ñ∂ New Game</button>
          <div style="height:8px"></div>
          <button class="btn big" id="continueBtn" title="Load your last save">‚è∏ Continue</button>
          <div style="height:8px"></div>
          <button class="btn big" id="howBtn">‚ùì How to Play</button>
          <div style="height:8px"></div>
          <button class="btn big" id="optionsBtn">‚öô Options</button>
          <div style="height:8px"></div>
          <button class="btn big" id="leaderBtn">üèÜ Leaderboard</button>
          <div style="height:8px"></div>
          <button class="btn ghost big" id="creditsBtn">¬© Credits</button>
        </div>
        <div class="col">
          <h2>Status</h2>
          <div class="kv"><span>Saved Game</span><span id="saveStatus" class="badge">None</span></div>
          <div class="kv"><span>High Score</span><span id="hiStatus" class="badge">0</span></div>
          <div class="hr"></div>
          <p class="note">Tip: Press <span class="kbd">F</span> to toggle fullscreen while playing.</p>
        </div>
      </div>
    </div>

    <!-- Options -->
    <div id="options" class="panel">
      <h1>Options</h1>
      <div class="grid">
        <div>
          <h2>Audio</h2>
          <label>SFX Volume <span id="sfxVolLbl" class="right"></span></label>
          <input id="sfxVol" type="range" min="0" max="100" value="70">
          <label>Music Volume <span id="musVolLbl" class="right"></span></label>
          <input id="musVol" type="range" min="0" max="100" value="50">
          <div class="kv" style="margin-top:8px">
            <span>Mute All</span>
            <label class="right"><input type="checkbox" id="muteAll"> <span class="note">toggle</span></label>
          </div>
        </div>
        <div>
          <h2>Graphics</h2>
          <div class="kv"><span>Particles</span><label class="right"><input type="checkbox" id="optParticles" checked></label></div>
          <div class="kv"><span>Screen Shake</span><label class="right"><input type="checkbox" id="optShake" checked></label></div>
          <div class="kv"><span>Star Density</span><span class="right"><select id="optStars"><option value="low">Low</option><option value="med" selected>Medium</option><option value="high">High</option></select></span></div>
          <div class="kv"><span>Reduce Motion</span><label class="right"><input type="checkbox" id="optReduce"></label></div>
          <div class="kv"><span>Bloom</span><label class="right"><input type="checkbox" id="optBloom" checked></label></div>
        </div>
        <div>
          <h2>Gameplay</h2>
          <div class="kv"><span>Difficulty</span>
            <span class="right">
              <select id="optDifficulty">
                <option value="easy">Easy</option>
                <option value="normal" selected>Normal</option>
                <option value="hard">Hard</option>
                <option value="insane">Insane</option>
              </select>
            </span>
          </div>
          <div class="kv"><span>Auto-Fire</span><label class="right"><input type="checkbox" id="optAutoFire" checked></label></div>
          <div class="kv"><span>Vibrate on Hit (mobile)</span><label class="right"><input type="checkbox" id="optVibrate" checked></label></div>
        </div>
        <div>
          <h2>Controls</h2>
          <ul class="list" id="bindList"></ul>
          <p class="note">Click a binding to rebind. Dupes are prevented.</p>
        </div>
      </div>
      <div class="hr"></div>
      <div class="center">
        <button class="btn" id="optBack">‚Üê Back</button>
        <button class="btn" id="optDefaults">Reset to Defaults</button>
        <button class="btn" id="optSave">Save Options</button>
      </div>
    </div>

    <!-- How to Play -->
    <div id="how" class="panel">
      <h1>How to Play</h1>
      <div class="grid">
        <div>
          <h2>Goal</h2>
          <p>Defend the sector from waves of invaders. Destroy enemies, dodge bullets, collect power‚Äëups, and defeat bosses. Build your <strong>Hyper</strong> meter, then unleash slow‚Äëmo for clutch plays. Use <strong>Dash</strong> to phase through danger.</p>
          <h2>Scoring</h2>
          <p>Maintain combos for multipliers. Hyper and Drones help extend streaks. Mines shower shrapnel‚Äîdetonate at range.</p>
        </div>
        <div>
          <h2>Controls</h2>
          <ul class="list">
            <li><span>Move</span><span class="kbd">‚Üê ‚Üí</span></li>
            <li><span>Fire</span><span class="kbd">Space</span></li>
            <li><span>Bomb</span><span class="kbd">Shift</span></li>
            <li><span>Special (Hyper)</span><span class="kbd">E</span></li>
            <li><span>Dash</span><span class="kbd">Q</span></li>
            <li><span>Pause</span><span class="kbd">Esc</span></li>
          </ul>
          <p class="note">Touch: onscreen left/right, Fire/Bomb, plus **Hyper** and **Dash** buttons.</p>
        </div>
      </div>
      <div class="hr"></div>
      <div class="center"><button id="howBack" class="btn">‚Üê Back</button></div>
    </div>

    <!-- Leaderboard -->
    <div id="leader" class="panel">
      <h1>Local Leaderboard</h1>
      <ul class="list" id="leaderList"></ul>
      <div class="hr"></div>
      <div class="center">
        <button class="btn" id="leaderBack">‚Üê Back</button>
        <button class="btn red" id="leaderClear">Clear Scores</button>
      </div>
    </div>

    <!-- Credits -->
    <div id="credits" class="panel">
      <h1>Credits</h1>
      <p>Design &amp; Code: <span class="badge">You + GPT‚Äë5 Pro</span></p>
      <p class="note">Built with HTML5 Canvas &amp; Web Audio. No external assets.</p>
      <div class="center"><button class="btn" id="creditsBack">‚Üê Back</button></div>
    </div>

    <!-- Pause Overlay -->
    <div id="pauseOverlay" hidden>
      <div class="overlay-card">
        <h2>Game Paused</h2>
        <p class="note">Press Esc to resume, or choose an option below.</p>
        <div class="overlay-actions">
          <button class="btn" id="resumeBtn">Resume</button>
          <button class="btn" id="restartBtn">Restart</button>
          <button class="btn" id="toMenuBtn">Main Menu</button>
        </div>
      </div>
    </div>

    <!-- Game Over Overlay -->
    <div id="gameOverOverlay" hidden>
      <div class="overlay-card">
        <h2>Game Over</h2>
        <div class="row">
          <div class="col">
            <div class="kv"><span>Score</span><strong id="finalScore">0</strong></div>
            <div class="kv"><span>Wave</span><strong id="finalWave">1</strong></div>
            <div class="kv"><span>Accuracy</span><strong id="finalAcc">0%</strong></div>
          </div>
          <div class="col">
            <label>Your Name</label>
            <input type="text" id="playerName" maxlength="16" placeholder="Rookie Pilot">
          </div>
        </div>
        <div class="overlay-actions">
          <button class="btn" id="saveScoreBtn">Save Score</button>
          <button class="btn" id="gameOverMenuBtn">Main Menu</button>
        </div>
      </div>
    </div>

    <!-- Tiny toasts (power-up etc.) -->
    <div id="tinyToasts"></div>

    <!-- Mobile Controls -->
    <div id="mobile" aria-hidden="true">
      <div class="center" style="gap:8px">
        <div class="thumb" id="leftBtn">‚Üê</div>
        <div class="thumb" id="rightBtn">‚Üí</div>
      </div>
      <div class="center" style="gap:8px">
        <div class="thumb" id="fireBtn">FIRE</div>
        <div class="thumb" id="bombBtn">BOMB</div>
      </div>
      <div class="center" style="gap:8px">
        <div class="thumb small" id="hyperBtn">HYPER</div>
        <div class="thumb small" id="dashBtn">DASH</div>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
'use strict';

/** Galaxy Patrol ‚Äî Hyperdrive Edition (v1.1.0)
 *  Adds Hyperdrive, Dash, Missiles, Drones, Seeker & Mine enemies, futuristic UI.
 */

/* ==============================
   Helpers
   ============================== */
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const rand = (min,max)=>Math.random()*(max-min)+min;
const randi = (min,max)=>Math.floor(rand(min,max+1));
const PI = Math.PI;

/** Safe JSON storage */
const Store = {
  get(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){ return fallback; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); return true; }catch(e){ return false; } },
  del(key){ try{ localStorage.removeItem(key); }catch(e){} }
};

/* ==============================
   Config & Defaults
   ============================== */
const DEFAULT_OPTIONS = {
  audio:{ sfx:0.7, music:0.5, mute:false },
  gfx:{ particles:true, shake:true, stars:'med', reduce:false, bloom:true },
  gameplay:{ difficulty:'normal', autoFire:true, vibrate:true },
  controls:{
    LEFT:'ArrowLeft', RIGHT:'ArrowRight', FIRE:'Space', BOMB:'ShiftLeft',
    SPECIAL:'KeyE', DASH:'KeyQ', PAUSE:'Escape', FULLSCREEN:'KeyF', MUTE:'KeyM'
  }
};
const DIFFICULTY = {
  easy:{ enemyHp:0.8, bulletRate:0.85, enemySpeed:0.9, playerLives:5 },
  normal:{ enemyHp:1.0, bulletRate:1.0, enemySpeed:1.0, playerLives:3 },
  hard:{ enemyHp:1.25, bulletRate:1.1, enemySpeed:1.05, playerLives:3 },
  insane:{ enemyHp:1.5, bulletRate:1.25, enemySpeed:1.12, playerLives:2 }
};

/* ==============================
   Canvas
   ============================== */
const BASE_W = 480, BASE_H = 270;
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { desynchronized:true });
let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function resizeCanvas(){
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const scale = Math.min(window.innerWidth/BASE_W, window.innerHeight/BASE_H);
  canvas.style.width = (BASE_W*scale)+'px';
  canvas.style.height = (BASE_H*scale)+'px';
  canvas.width  = Math.floor(BASE_W*DPR);
  canvas.height = Math.floor(BASE_H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvas);
/* Paint boot bg so canvas isn't white before first draw */
function paintBootBG(){
  const g = ctx; const grd = g.createLinearGradient(0,0,0,BASE_H);
  grd.addColorStop(0,'#0b133a'); grd.addColorStop(1,'#081028');
  g.fillStyle = grd; g.fillRect(0,0,BASE_W,BASE_H);
}

/* ==============================
   Toasts
   ============================== */
const toasts = document.getElementById('tinyToasts');
function toast(msg){
  const el=document.createElement('div'); el.className='toast'; el.textContent=msg;
  toasts.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),250); }, 1600);
}

/* ==============================
   Input (keyboard + touch)
   ============================== */
class Input{
  constructor(bindings){
    this.bindings={...bindings};
    this.down=new Set(); this.pressed=new Set(); this.released=new Set();
    this.busyRebind=null;
    // touch flags
    this.touch={LEFT:false,RIGHT:false,FIRE:false,BOMB:false,SPECIAL:false,DASH:false};
    window.addEventListener('keydown',e=>{
      if (rebindTryCapture(e)) return;
      if (document.activeElement && ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
      this._setKey(e.code,true);
      if (['ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault();
    },{passive:false});
    window.addEventListener('keyup',e=>this._setKey(e.code,false));
    window.addEventListener('blur',()=>{ this.down.clear(); this.pressed.clear(); this.released.clear(); });

    bindTouchButton('leftBtn', v=>this.touch.LEFT=v);
    bindTouchButton('rightBtn', v=>this.touch.RIGHT=v);
    bindTouchButton('fireBtn', v=>this.touch.FIRE=v);
    bindTouchButton('bombBtn', v=>this.touch.BOMB=v);
    bindTouchButton('hyperBtn', v=>this.touch.SPECIAL=v);
    bindTouchButton('dashBtn', v=>this.touch.DASH=v);
  }
  _setKey(code,isDown){
    for(const [action,key] of Object.entries(this.bindings)){
      if (key===code){
        if (isDown){ if (!this.down.has(action)) this.pressed.add(action); this.down.add(action); }
        else{ this.down.delete(action); this.released.add(action); }
      }
    }
  }
  postUpdate(){ this.pressed.clear(); this.released.clear(); }
  isDown(action){
    if (this.touch[action]!==undefined) return this.down.has(action) || this.touch[action];
    return this.down.has(action);
  }
  isPressed(action){ return this.pressed.has(action); }
  setBinding(action,code){ this.bindings[action]=code; }
}
function bindTouchButton(id, setter){
  const el=document.getElementById(id);
  const on=e=>{ e.preventDefault(); setter(true); };
  const off=e=>{ e.preventDefault(); setter(false); };
  el.addEventListener('touchstart', on,{passive:false});
  el.addEventListener('touchend', off,{passive:false});
  el.addEventListener('touchcancel', off,{passive:false});
  el.addEventListener('mousedown', on);
  window.addEventListener('mouseup', off);
}

/* ==============================
   Audio (synth SFX)
   ============================== */
class AudioMgr{
  constructor(){ this.ctx=null; this.master=null; this.music=null; this.sfxVol=.7; this.musicVol=.5; this.mute=false; }
  init(){
    if (this.ctx) return; const AC=window.AudioContext||window.webkitAudioContext; if (!AC) return;
    this.ctx=new AC();
    this.master=this.ctx.createGain(); this.master.gain.value=1; this.master.connect(this.ctx.destination);
    this.music=this.ctx.createGain(); this.music.gain.value=0; this.music.connect(this.master);
    // gentle pad
    const osc=this.ctx.createOscillator(), lfo=this.ctx.createOscillator(), mod=this.ctx.createGain();
    lfo.frequency.value=.08; mod.gain.value=12; lfo.connect(mod); mod.connect(osc.frequency);
    osc.type='sine'; osc.frequency.value=220; const filt=this.ctx.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=600;
    osc.connect(filt); filt.connect(this.music); osc.start(); lfo.start();
  }
  setVolumes(sfx,music){ this.sfxVol=sfx; this.musicVol=music; if (this.music) this.music.gain.value=(this.mute?0:this.musicVol*0.3); }
  setMute(m){ this.mute=!!m; if (this.music) this.music.gain.value=(this.mute?0:this.musicVol*0.3); }
  resume(){ if (this.ctx && this.ctx.state==='suspended') this.ctx.resume(); }
  beep(freq=440,dur=.1,type='square',glideTo=null,color=0){
    if (!this.ctx||this.mute||this.sfxVol<=0) return;
    const t=this.ctx.currentTime, o=this.ctx.createOscillator(); o.type=type; o.frequency.value=freq;
    const g=this.ctx.createGain(); g.gain.value=0;
    const f=this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=12000-color*8000;
    o.connect(f); f.connect(g); g.connect(this.master);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(this.sfxVol,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+dur);
    if (glideTo){ o.frequency.setValueAtTime(freq,t); o.frequency.exponentialRampToValueAtTime(glideTo,t+dur); }
    o.start(t); o.stop(t+dur+.02);
  }
  pew(){ this.beep(760,.08,'square',880,0); }
  boom(){ this.beep(120,.3,'sawtooth',60,2); }
  hit(){ this.beep(480,.06,'triangle',300,1); }
  power(){ this.beep(420,.2,'square',600,0); }
  dash(){ this.beep(640,.07,'sine',960,0); }
  hyper(){ this.beep(480,.25,'triangle',960,0); this.beep(720,.25,'sine',1440,0); }
}
const Audio = new AudioMgr();

/* ==============================
   Entities
   ============================== */
class Entity{ constructor(x,y,r){ this.x=x; this.y=y; this.r=r; this.vx=0; this.vy=0; this.alive=true; } update(dt,game){} draw(g){} }
function circlesCollide(a,b){ const dx=a.x-b.x, dy=a.y-b.y; const rr=(a.r+b.r)*(a.r+b.r); return dx*dx+dy*dy<=rr; }

class Player extends Entity{
  constructor(x,y){
    super(x,y,6);
    this.speed=120; this.cool=0; this.fireRate=.15; this.bombs=3; this.lives=3; this.inv=0;
    this.weapon='BLASTER'; this.weaponTimer=0; this.accuracy={shots:0,hits:0}; this.shield=0;
    this.lastDir=1; this.dashCD=0; this.dashLock=0;
  }
  canFire(){ return this.cool<=0; }
  dash(game,dir){
    if (this.dashCD>0 || !dir) return;
    this.x = clamp(this.x + dir*80, 10, BASE_W-10);
    this.inv = Math.max(this.inv, 0.22);
    this.dashCD = 1.0; this.dashLock = .14;
    for(let i=0;i<12;i++){
      const a=rand(-PI,PI); game.parts.push(new Particle(this.x-10*dir, this.y, Math.cos(a)*40, Math.sin(a)*30, rand(.25,.45), '#aef2ff'));
    }
    Audio.dash();
  }
  applyDamage(game){
    if (this.inv>0) return;
    if (this.shield>0){ this.shield=0; game.shake(4,.3); toast('Shield broke!'); Audio.hit(); return; }
    this.lives -= 1; this.inv=2.0; game.onPlayerHurt();
    if (game.opts.gameplay.vibrate && ('vibrate' in navigator)) navigator.vibrate(100);
    if (this.lives<0) this.alive=false;
  }
  update(dt,game,input){
    let dir=0; if (input.isDown('LEFT')) dir-=1; if (input.isDown('RIGHT')) dir+=1;
    if (dir!==0) this.lastDir=dir;
    this.x += dir*this.speed*dt; this.x = clamp(this.x, 10, BASE_W-10);
    if (input.isDown('DASH') && this.dashLock<=0) { this.dash(game, this.lastDir||1); }
    this.cool=Math.max(0,this.cool-dt);
    this.dashCD=Math.max(0,this.dashCD-dt);
    this.dashLock=Math.max(0,this.dashLock-dt);
    if (this.inv>0) this.inv-=dt;
    if (this.weaponTimer>0){ this.weaponTimer-=dt; if (this.weaponTimer<=0){ this.weapon='BLASTER'; toast('Weapon reset'); } }
    if (this.shield>0) this.shield-=dt;
  }
  draw(g){
    g.save();
    if (this.inv>0 && Math.floor(this.inv*10)%2===0) g.globalAlpha=.45;
    g.translate(this.x,this.y);
    g.shadowColor='#69e6ff'; g.shadowBlur=10;
    g.fillStyle='#adf0ff';
    g.beginPath(); g.moveTo(0,-8); g.lineTo(9,6); g.lineTo(2,3); g.lineTo(-2,3); g.lineTo(-9,6); g.closePath(); g.fill();
    g.shadowBlur=0; g.fillStyle='#2b3d78';
    g.beginPath(); g.arc(0,-2,3,0,PI*2); g.fill();
    if (this.shield>0){ g.strokeStyle='#9aff7a'; g.lineWidth=1.5; g.beginPath(); g.arc(0,0,10,0,PI*2); g.stroke(); }
    g.restore();
  }
}

class Bullet extends Entity{
  constructor(x,y,vx,vy,friendly=true,dmg=1,pierce=false){
    super(x,y, friendly?2:2.5);
    this.vx=vx; this.vy=vy; this.friendly=friendly; this.dmg=dmg; this.pierce=pierce; this.life=4;
  }
  update(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; this.life-=dt; if (this.life<=0) this.alive=false; }
  draw(g){ g.save(); g.shadowColor=this.friendly?'#6fe1ff':'#ff8888'; g.shadowBlur=6; g.fillStyle=this.friendly?'#cbf6ff':'#ffc4c4';
    g.beginPath(); g.arc(this.x,this.y,this.r,0,PI*2); g.fill(); g.restore(); }
}
/* Homing missile (friendly) */
class Missile extends Bullet{
  constructor(x,y){ super(x,y,0,-100,true,2,false); this.turn=3.2; this.speed=130; this.target=null; this.smoke=0; }
  acquire(game){
    let best=null,bestd=1e9;
    for(const e of game.enemies){ const dx=e.x-this.x, dy=e.y-this.y; const d=dx*dx+dy*dy; if (d<bestd){ bestd=d; best=e; } }
    this.target=best;
  }
  update(dt,game){
    if (!this.target || !this.target.alive) this.acquire(game);
    if (this.target){
      const ang=Math.atan2(this.target.y-this.y,this.target.x-this.x);
      const cur=Math.atan2(this.vy,this.vx);
      let diff=ang-cur; while(diff>PI) diff-=2*PI; while(diff<-PI) diff+=2*PI;
      const turn=clamp(diff,-this.turn*dt,this.turn*dt);
      const na=cur+turn; this.vx=Math.cos(na)*this.speed; this.vy=Math.sin(na)*this.speed;
    }else{ this.vy=-this.speed; }
    super.update(dt);
    if (game.opts.gfx.particles){ this.smoke-=dt; if (this.smoke<=0){ this.smoke=.04; game.parts.push(new Particle(this.x,this.y,rand(-10,10),rand(10,30),.3,'#a8ecff')); } }
  }
  draw(g){ g.save(); g.translate(this.x,this.y); const a=Math.atan2(this.vy,this.vx); g.rotate(a+PI/2);
    g.shadowColor='#aaf6ff'; g.shadowBlur=8; g.fillStyle='#e0fbff';
    g.beginPath(); g.moveTo(0,-5); g.lineTo(3,5); g.lineTo(-3,5); g.closePath(); g.fill(); g.restore(); }
}

class Particle extends Entity{
  constructor(x,y,vx,vy,life,color){ super(x,y,1.5); this.vx=vx; this.vy=vy; this.life=life; this.color=color; this.t=life; }
  update(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; this.vx*=.985; this.vy*=.985; this.t-=dt; if (this.t<=0) this.alive=false; }
  draw(g){ const a=clamp(this.t/this.life,0,1); g.save(); g.globalAlpha=a; g.fillStyle=this.color; g.fillRect(this.x,this.y,2,2); g.restore(); }
}

class PowerUp extends Entity{
  constructor(x,y,type){ super(x,y,5); this.type=type; this.vy=30; this.t=10; }
  update(dt){ this.y+=this.vy*dt; this.t-=dt; if (this.t<=0||this.y>BASE_H+10) this.alive=false; }
  draw(g){ g.save(); g.translate(this.x,this.y); g.shadowBlur=10; g.shadowColor='#ffd84d'; g.fillStyle='#fff199';
    g.beginPath(); g.arc(0,0,5,0,PI*2); g.fill();
    g.shadowBlur=0; g.fillStyle='#222'; g.font='8px monospace'; g.textAlign='center'; g.textBaseline='middle'; g.fillText(this.type[0],0,0.5);
    g.restore(); }
}

/* Drone companion */
class Drone extends Entity{
  constructor(angle){ super(0,0,3); this.angle=angle; this.cool=.42; this.t=0; }
  update(dt,game){
    this.angle += dt*2.6;
    this.x = game.player.x + Math.cos(this.angle)*22;
    this.y = game.player.y + Math.sin(this.angle)*12 - 6;
    this.t -= dt;
    if (this.t<=0){ this.t=this.cool; game.bullets.push(new Bullet(this.x,this.y-2,0,-220,true,.8,false)); }
  }
  draw(g){ g.save(); g.translate(this.x,this.y); g.shadowColor='#6fe1ff'; g.shadowBlur=6; g.fillStyle='#baf0ff'; g.beginPath(); g.arc(0,0,3,0,PI*2); g.fill(); g.restore(); }
}

/* Enemy */
class Enemy extends Entity{
  constructor(x,y,kind='grunt'){
    super(x,y,6); this.kind=kind;
    this.hp={grunt:2,swoop:2,shooter:4,tank:7,boss:100,seeker:3,mine:3}[kind]||2;
    this.baseHp=this.hp; this.t=0; this.fire=rand(.6,1.6);
    this.value={grunt:100,swoop:150,shooter:220,tank:320,boss:5000,seeker:180,mine:200}[kind]||100;
  }
  update(dt,game){
    this.t+=dt; const sm=game.diff.enemySpeed;
    if (this.kind==='grunt'){ this.vx=Math.sin((this.y+this.t)*.3)*10*sm; this.vy=12*sm; }
    else if (this.kind==='swoop'){ this.vx=Math.sin((this.y+this.t*60)*.08)*60*sm; this.vy=35*sm; }
    else if (this.kind==='shooter'){ this.vx=Math.cos(this.t*1.5)*30*sm; this.vy=18*sm; }
    else if (this.kind==='tank'){ this.vx=Math.sin(this.t*.9)*18*sm; this.vy=14*sm; }
    else if (this.kind==='seeker'){ const dir = Math.sign(game.player.x - this.x)||0; this.vx = clamp(this.vx + dir*40*dt, -50, 50); this.vy=26*sm; }
    else if (this.kind==='mine'){ this.vx = Math.sin(this.t*.7)*8*sm; this.vy=16*sm; }
    else if (this.kind==='boss'){ this.vx=Math.sin(this.t*.8)*22*sm; this.vy=8*sm*(Math.sin(this.t*.5)*.5+.5); }
    this.x+=this.vx*dt; this.y+=this.vy*dt; if (this.y>BASE_H+20) this.alive=false;

    this.fire -= dt; const rate=game.diff.bulletRate;
    if (this.kind!=='grunt' && this.kind!=='mine' && this.fire<=0){
      this.fire=rand(.9,1.8)/rate;
      const aim=Math.atan2(game.player.y-this.y,game.player.x-this.x);
      const spd=(this.kind==='boss'?85:70); const spread=(this.kind==='boss'?0.25:0.1);
      const bullets=(this.kind==='tank'?2:1)+(this.kind==='boss'?4:0);
      for(let i=0;i<bullets;i++){
        const ang=aim+(i-(bullets-1)/2)*spread;
        game.enemyBullets.push(new Bullet(this.x,this.y,Math.cos(ang)*spd,Math.sin(ang)*spd,false,this.kind==='boss'?2:1));
      }
    }
  }
  draw(g){
    g.save(); g.translate(this.x,this.y);
    const boss=(this.kind==='boss'); g.shadowBlur=6; g.shadowColor=boss?'#ffd84d':'#ff8888';
    g.fillStyle=boss?'#ffe17d':'#ffc1c1';
    g.beginPath();
    if (this.kind==='grunt'){ g.moveTo(0,-6); g.lineTo(7,4); g.lineTo(-7,4); }
    else if (this.kind==='swoop'){ g.moveTo(-7,-2); g.lineTo(7,-2); g.lineTo(0,5); }
    else if (this.kind==='shooter'){ g.moveTo(-6,-5); g.lineTo(6,-5); g.lineTo(8,5); g.lineTo(-8,5); }
    else if (this.kind==='tank'){ g.moveTo(-8,-6); g.lineTo(8,-6); g.lineTo(6,6); g.lineTo(-6,6); }
    else if (this.kind==='seeker'){ g.moveTo(-7,-5); g.lineTo(7,-5); g.lineTo(5,6); g.lineTo(-5,6); }
    else if (this.kind==='mine'){ g.moveTo(-6,-6); g.lineTo(6,-6); g.lineTo(6,6); g.lineTo(-6,6); }
    else if (boss){ g.moveTo(-14,-10); g.lineTo(14,-10); g.lineTo(18,8); g.lineTo(-18,8); }
    g.closePath(); g.fill();
    if (boss || this.kind==='tank'){
      const w=boss?36:16,h=2,pct=clamp(this.hp/this.baseHp,0,1);
      g.shadowBlur=0; g.fillStyle='#2a335a'; g.fillRect(-w/2,-14,w,h);
      g.fillStyle=boss?'#ffd84d':'#ff8b8b'; g.fillRect(-w/2,-14,w*pct,h);
    }
    g.restore();
  }
}

/* ==============================
   Background stars
   ============================== */
class Stars{
  constructor(density='med'){ this.layers=[]; this.setDensity(density); }
  setDensity(d){ const base={low:50,med:100,high:160}[d]||100;
    this.layers=[ this.make(base,8,'#bcd1ff'), this.make(Math.floor(base*.6),16,'#8aa3ff'), this.make(Math.floor(base*.4),28,'#5570ff') ];
  }
  make(n,spd,col){ const a=[]; for(let i=0;i<n;i++) a.push({x:Math.random()*BASE_W,y:Math.random()*BASE_H,s:Math.random()*1.6+.3,v:spd*(.7+Math.random()*.6),c:col}); return a; }
  update(dt){ for(const L of this.layers) for(const s of L){ s.y+=s.v*dt; if (s.y>BASE_H) s.y-=BASE_H; } }
  draw(g){ for(const L of this.layers){ g.save(); for(const s of L){ g.fillStyle=s.c; g.globalAlpha=clamp(s.s/2.2,.3,.9); g.fillRect(s.x,s.y,s.s,s.s);} g.restore(); } }
}

/* ==============================
   Wave manager
   ============================== */
class WaveMgr{
  constructor(game){ this.game=game; this.wave=1; this.inProgress=false; this.timer=0; }
  start(){ this.inProgress=false; this.timer=0; this.wave=1; }
  update(dt){
    if (this.inProgress){
      if (this.game.enemies.length===0 && this.game.enemyBullets.length<2){
        this.inProgress=false; this.timer=1.5; this.game.comboTimer = Math.max(this.game.comboTimer,3);
      }
      return;
    }
    this.timer -= dt;
    if (this.timer<=0){ this.spawnWave(this.wave); this.inProgress=true; this.wave+=1; }
  }
  spawnWave(n){
    const g=this.game, diff=g.diff, add=(x,y,k)=>g.enemies.push(new Enemy(x,y,k));
    if (n%5===0){ const b=new Enemy(BASE_W/2,-20,'boss'); b.hp=Math.floor(b.hp*diff.enemyHp*1.2+n*1.2); g.enemies.push(b); toast('‚ö† BOSS APPROACHING ‚ö†'); return; }
    const p=(n%6);
    if (p===1){ const rows=3,cols=7;
      for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
        const ex=40+c*((BASE_W-80)/(cols-1)), ey=-60-r*20;
        add(ex,ey, r===rows-1 ? 'shooter' : 'grunt');
      }
    }else if (p===2){ for(let i=0;i<10;i++) add(rand(60,BASE_W-60),-i*22-20,'swoop'); }
    else if (p===3){ for(let i=0;i<3;i++) add(BASE_W*(i+1)/4,-20-i*24,'tank'); for(let i=0;i<8;i++) add(rand(30,BASE_W-30),-i*14-16,'grunt'); }
    else if (p===4){ for(let i=0;i<8;i++) add(rand(30,BASE_W-30),-i*18-20,'seeker'); }
    else if (p===5){ for(let i=0;i<7;i++) add(30+i*((BASE_W-60)/6),-i*18-20,'mine'); }
    else { for(let i=0;i<6;i++) add(20+i*((BASE_W-40)/5),-20-i*16,'shooter'); }
    for(const e of g.enemies){ e.hp=Math.ceil(e.hp*diff.enemyHp+n*0.15); e.baseHp=e.hp; }
  }
}

/* ==============================
   Game core
   ============================== */
class Game{
  constructor(options){
    this.opts=options;
    this.input=new Input(options.controls);
    this.stars=new Stars(this.opts.gfx.stars);
    this.player=new Player(BASE_W/2,BASE_H-20);
    this.bullets=[]; this.enemyBullets=[]; this.enemies=[]; this.parts=[]; this.powerUps=[];
    this.drones=[];
    this.waveMgr=new WaveMgr(this);
    this.combo=0; this.comboTimer=0; this.score=0; this.wave=1;
    this.shakeTime=0; this.shakeAmp=0;
    this.modHoming=0; this.missileTimer=0;
    this.saved=null; this.diff=DIFFICULTY[this.opts.gameplay.difficulty]||DIFFICULTY.normal; this.player.lives=this.diff.playerLives;
    this.stats={shots:0,hits:0};
    this.accum=0; this.last=performance.now(); this.paused=false; this.running=false;
    this.speedMul=1; // global slowdown (Hyperdrive)
    this.hyper={meter:0,active:false,time:0};
    this.latch={BOMB:false,SPECIAL:false,DASH:false};
  }
  start(newGame=true){
    if (newGame){
      this.player=new Player(BASE_W/2,BASE_H-20); this.player.lives=this.diff.playerLives;
      this.bullets.length=0; this.enemyBullets.length=0; this.enemies.length=0; this.parts.length=0; this.powerUps.length=0; this.drones.length=0;
      this.score=0; this.combo=0; this.comboTimer=0; this.wave=1; this.waveMgr.start();
      this.modHoming=0; this.hyper={meter:0,active:false,time:0}; this.speedMul=1;
    }else if (this.saved){
      Object.assign(this,this.saved);
      this.player=Object.assign(new Player(0,0),this.player);
      this.waveMgr=new WaveMgr(this); this.waveMgr.wave=this.wave; this.waveMgr.inProgress=false; this.waveMgr.timer=.5;
    }
    this.running=true; this.last=performance.now(); this.accum=0;
  }
  saveSnapshot(){
    const snap={opts:this.opts, player:{...this.player,draw:undefined,update:undefined},
      score:this.score, combo:this.combo, comboTimer:this.comboTimer, wave:this.wave, hyper:this.hyper, modHoming:this.modHoming, drones:0};
    Store.set('gp_save',snap);
  }
  hasSave(){ return !!Store.get('gp_save',null); }
  loadSave(){ this.saved=Store.get('gp_save',null); }
  clearSave(){ Store.del('gp_save'); }
  addScore(v){ this.score += Math.round(v*(1+this.combo*0.1)); }
  onPlayerHurt(){ this.combo=0; this.comboTimer=0; this.shake(8,.45); }
  shake(a,d){ if (!this.opts.gfx.shake) return; this.shakeAmp=Math.max(this.shakeAmp,a); this.shakeTime=Math.max(this.shakeTime,d); }
  spawnExplosion(x,y,color='#ffd8a0'){ if (!this.opts.gfx.particles) return;
    for(let i=0;i<20;i++){ const a=rand(0,PI*2), s=rand(40,120); this.parts.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,rand(.3,.7),color)); } }
  gainHyper(a){ if (!this.hyper.active){ this.hyper.meter = clamp(this.hyper.meter + a, 0, 100); } }
  tryHyper(){
    if (this.hyper.active) return;
    if (this.hyper.meter>=100){ this.hyper.active=true; this.hyper.time=5; this.hyper.meter=0; this.speedMul=.6; toast('HYPERDRIVE!'); Audio.hyper(); }
    else{ toast('Hyper not ready'); }
  }
  endHyper(){ this.hyper.active=false; this.speedMul=1; }

  givePowerUp(type){
    const pick = type || (['SPREAD','PIERCE','RAPID','SHIELD','BOMB','MISSILE','DRONE'][randi(0,6)]);
    if (pick==='BOMB'){ this.player.bombs=Math.min(this.player.bombs+1,5); toast('Smart Bomb +1'); }
    else if (pick==='SHIELD'){ this.player.shield=12; toast('Shield!'); }
    else if (pick==='MISSILE'){ this.modHoming=18; toast('Homing missiles!'); }
    else if (pick==='DRONE'){ if (this.drones.length<2){ this.drones.push(new Drone(this.drones.length?Math.PI:0)); toast('Combat Drone online'); } else { this.player.shield=12; toast('Shield!'); } }
    else{ this.player.weapon=pick; this.player.weaponTimer=16; toast(pick==='PIERCE'?'Piercing rounds!':pick==='SPREAD'?'Spread shot!':'Rapid fire!'); }
    Audio.power();
  }
  fire(){
    if (!this.player.canFire()) return;
    const hyperMul = this.hyper.active ? .7 : 1;
    this.player.cool = (this.player.weapon==='RAPID' ? 0.09 : this.player.fireRate) * hyperMul;
    const y=this.player.y-10;
    const speedBoost = this.hyper.active ? 1.15 : 1;
    const add=(vx,vy,dmg=1,pierce=false)=>{ this.bullets.push(new Bullet(this.player.x,y,vx,vy*speedBoost,true,dmg,pierce)); };
    if (this.player.weapon==='BLASTER'){ add(0,-220,1,false); }
    else if (this.player.weapon==='SPREAD'){ add(0,-220,1,false); add(-90,-210,1,false); add(90,-210,1,false); }
    else if (this.player.weapon==='PIERCE'){ add(0,-250,1.2,true); }
    else if (this.player.weapon==='RAPID'){ add(0,-240,1,false); }
    this.player.accuracy.shots++; this.stats.shots++; Audio.pew();
    if (this.hyper.active){ // bonus side nudge in Hyper
      this.bullets.push(new Bullet(this.player.x-7,y-2,-40,-220*speedBoost,true,.8,false));
      this.bullets.push(new Bullet(this.player.x+7,y-2, 40,-220*speedBoost,true,.8,false));
    }
  }
  bomb(){
    if (this.player.bombs<=0) return;
    this.player.bombs--;
    this.enemyBullets.length=0;
    for(const e of this.enemies){ e.hp -= 3; }
    this.spawnExplosion(this.player.x,this.player.y,'#b3f7ff'); this.shake(12,.5); Audio.boom(); toast('SMART BOMB!');
  }
  update(dt){
    const sdt = dt * this.speedMul;

    // stars drift independent of hyper intensity (slightly reduced with reduce)
    this.stars.update(dt*(this.opts.gfx.reduce?0.5:1));

    if (this.paused || !this.running) return;

    this.waveMgr.update(sdt);

    // one-shot latches for touch buttons, so a hold triggers once
    const once=(action)=> this.input.isPressed(action) || (this.input.isDown(action) && !this.latch[action]);

    if (once('PAUSE')) this.togglePause(true);
    if (once('FULLSCREEN')) toggleFullscreen();
    if (once('MUTE')) { this.opts.audio.mute=!this.opts.audio.mute; Audio.setMute(this.opts.audio.mute); }

    if (this.opts.gameplay.autoFire && this.player.canFire()) this.fire();
    if (once('FIRE')) this.fire();
    if (once('BOMB')){ this.bomb(); this.latch.BOMB=true; } else if (!this.input.isDown('BOMB')) this.latch.BOMB=false;
    if (once('SPECIAL')){ this.tryHyper(); this.latch.SPECIAL=true; } else if (!this.input.isDown('SPECIAL')) this.latch.SPECIAL=false;
    if (once('DASH')){ this.player.dash(this, this.player.lastDir||1); this.latch.DASH=true; } else if (!this.input.isDown('DASH')) this.latch.DASH=false;

    // Player & entities
    this.player.update(sdt,this,this.input);
    for(const a of [this.bullets,this.enemyBullets,this.enemies,this.parts,this.powerUps]) for(const o of a) if (o.alive) o.update(sdt,this);
    for(const d of this.drones) if (d.alive) d.update(sdt,this);

    // Missiles auto-launch while mod active
    if (this.modHoming>0){ this.modHoming-=sdt; this.missileTimer-=sdt;
      if (this.missileTimer<=0){ this.missileTimer=.8; this.bullets.push(new Missile(this.player.x-6, this.player.y-10)); this.bullets.push(new Missile(this.player.x+6, this.player.y-10)); }
    }

    // Collisions: bullets -> enemies
    for(const b of this.bullets){
      if (!b.alive) continue;
      for(const e of this.enemies){
        if (!e.alive) continue;
        if (circlesCollide(b,e)){
          e.hp -= b.dmg;
          this.player.accuracy.hits++; this.stats.hits++;
          if (!b.pierce) b.alive=false;
          this.spawnExplosion(b.x,b.y,'#ffe9bf');
          if (e.hp<=0){
            e.alive=false; this.addScore(e.value); this.combo+=1; this.comboTimer=4; this.spawnExplosion(e.x,e.y);
            // hyper charge on kill (boss gives a chunk)
            this.gainHyper(e.kind==='boss'? 50 : 10);
            // mine shrapnel
            if (e.kind==='mine'){
              for(let i=0;i<8;i++){ const ang=i*(PI*2/8); this.enemyBullets.push(new Bullet(e.x,e.y,Math.cos(ang)*80,Math.sin(ang)*80,false,1)); }
            }
            if (Math.random()<0.12) this.powerUps.push(new PowerUp(e.x,e.y,['SPREAD','PIERCE','RAPID','SHIELD','BOMB','MISSILE','DRONE'][randi(0,6)]));
          }
        }
      }
    }
    // enemy bullets -> player
    for(const b of this.enemyBullets){
      if (b.alive && circlesCollide(b,this.player)){ b.alive=false; this.player.applyDamage(this); }
    }
    // enemies -> player
    for(const e of this.enemies){
      if (e.alive && circlesCollide(e,this.player)){ e.alive=false; this.spawnExplosion(e.x,e.y); this.player.applyDamage(this); }
    }
    // powerups -> player
    for(const p of this.powerUps){
      if (p.alive && circlesCollide(p,this.player)){ p.alive=false; this.givePowerUp(p.type); }
    }

    // cleanup
    this.bullets=this.bullets.filter(o=>o.alive && o.y>-12);
    this.enemyBullets=this.enemyBullets.filter(o=>o.alive && o.y<BASE_H+12);
    this.enemies=this.enemies.filter(o=>o.alive);
    this.parts=this.parts.filter(o=>o.alive);
    this.powerUps=this.powerUps.filter(o=>o.alive);
    this.drones=this.drones.filter(o=>o.alive!==false);

    // timers
    if (this.comboTimer>0){ this.comboTimer-=sdt; if (this.comboTimer<=0) this.combo=0; }
    if (this.shakeTime>0) this.shakeTime-=sdt;

    // hyper timing
    if (this.hyper.active){ this.hyper.time-=dt; if (this.hyper.time<=0) this.endHyper(); }

    this.wave=this.waveMgr.wave-1;
    if (!this.player.alive) this.endGame();
  }
  draw(g){
    // Background
    g.save();
    const bg=g.createLinearGradient(0,0,0,BASE_H); bg.addColorStop(0,'#0b133a'); bg.addColorStop(1,'#081028'); g.fillStyle=bg; g.fillRect(0,0,BASE_W,BASE_H);
    this.stars.draw(g);

    if (this.shakeTime>0){ const s=this.shakeAmp*(this.shakeTime); g.translate(rand(-s,s),rand(-s,s)); }

    // game layer: particles, powerups, enemies, enemy bullets, bullets, drones, player
    for(const a of [this.parts,this.powerUps,this.enemies,this.enemyBullets,this.bullets]) for(const o of a) o.draw(g);
    for(const d of this.drones) d.draw(g);
    this.player.draw(g);
    g.restore();

    // HUD
    g.save();
    g.fillStyle='#d6e5ff'; g.font='bold 12px system-ui, sans-serif'; g.textAlign='left'; g.textBaseline='top';
    g.fillText(`Score: ${this.score}`, 6, 6);
    g.fillText(`Lives: ${Math.max(this.player.lives,0)}  Bombs: ${this.player.bombs}`, 6, 22);
    g.fillText(`Wave: ${Math.max(this.wave,1)}  Weapon: ${this.player.weapon}${this.player.weaponTimer>0?` (${this.player.weaponTimer|0}s)`:''}`, 6, 38);
    if (this.combo>0){ g.textAlign='right'; g.fillStyle='#ffd84d'; g.fillText(`Combo x${(1+this.combo*0.1).toFixed(1)} (${this.combo})`, BASE_W-6, 6); }

    // Dash meter (top-right small)
    const dc = clamp(1-this.player.dashCD/1.0,0,1); // 0..1 ready fill
    g.strokeStyle='#3950b3'; g.lineWidth=1; g.strokeRect(BASE_W-78,6,72,8);
    g.fillStyle= dc>=1? '#9aff7a' : '#6fe1ff';
    g.fillRect(BASE_W-78,6,72*dc,8);
    g.fillStyle='#b4c6ff'; g.textAlign='right'; g.fillText('Dash', BASE_W-6, 18);

    // Hyper meter (bottom center)
    const w=160, h=10, x=(BASE_W-w)/2, y=BASE_H-16;
    g.strokeStyle='#3b4fa0'; g.lineWidth=1; g.strokeRect(x,y,w,h);
    const hm = clamp(this.hyper.meter/100,0,1); g.fillStyle= hm>=1?'#ff80e8':'#6fe1ff'; g.fillRect(x,y,w*hm,h);
    g.textAlign='center'; g.fillStyle='#b8c7ff'; g.fillText(hm>=1?'HYPER READY (E)':'Hyper', BASE_W/2, y-12);

    // Hyper bloom overlay
    if (this.hyper.active && this.opts.gfx.bloom){
      g.fillStyle='rgba(255,128,232,0.08)'; g.fillRect(0,0,BASE_W,BASE_H);
    }

    if (this.paused){ g.textAlign='center'; g.fillStyle='#b8c5ff'; g.fillText('PAUSED', BASE_W/2, BASE_H/2 - 40); }
    g.restore();
  }
  togglePause(showOverlay=false){ this.paused=!this.paused; document.getElementById('pauseOverlay').hidden = !this.paused || !showOverlay; }
  endGame(){
    this.running=false; this.paused=false;
    const acc=this.stats.shots>0?Math.round(100*this.stats.hits/this.stats.shots):0;
    document.getElementById('finalScore').textContent=this.score.toString();
    document.getElementById('finalWave').textContent=Math.max(this.wave,1).toString();
    document.getElementById('finalAcc').textContent=acc+'%';
    document.getElementById('gameOverOverlay').hidden=false;
    this.clearSave();
  }
}

/* ==============================
   Loop (fixed timestep)
   ============================== */
const gameState={game:null}; let rafId=0;
function gameLoop(ts){
  const g=gameState.game; if (!g){ rafId=requestAnimationFrame(gameLoop); return; }
  let dt=(ts-g.last)/1000; if (dt>0.1) dt=0.1; g.last=ts;
  const step=1/60; g.accum+=dt;
  while(g.accum>=step){ g.update(step); g.input.postUpdate(); g.accum-=step; }
  ctx.save(); ctx.clearRect(0,0,BASE_W,BASE_H); g.draw(ctx); ctx.restore();
  rafId=requestAnimationFrame(gameLoop);
}

/* ==============================
   Menus & wiring
   ============================== */
const $=sel=>document.querySelector(sel);
const panels={menu:$('#menu'),options:$('#options'),how:$('#how'),leader:$('#leader'),credits:$('#credits')};

function showPanel(name){ for(const [k,el] of Object.entries(panels)){ if (!el) continue; if (k===name) el.classList.add('visible'); else el.classList.remove('visible'); } }
function hideAllPanels(){ for(const el of Object.values(panels)) el.classList.remove('visible'); }

function refreshMenuStatus(){
  const save=Store.get('gp_save',null);
  $('#saveStatus').textContent=save?'Available':'None';
  $('#continueBtn').disabled=!save;
  const hi=Store.get('gp_scores',[]).sort((a,b)=>b.score-a.score)[0]?.score||0;
  $('#hiStatus').textContent=hi.toString();
}
function populateLeaderboard(){
  const list=$('#leaderList'); list.innerHTML='';
  const scores=Store.get('gp_scores',[]).sort((a,b)=>b.score-a.score).slice(0,10);
  if (!scores.length){ const li=document.createElement('li'); li.innerHTML='<span>No scores yet</span><span class="badge">Play a game!</span>'; list.appendChild(li); return; }
  scores.forEach((s,i)=>{ const li=document.createElement('li'); li.innerHTML=`<span>#${i+1} ${s.name||'Pilot'}</span><span>${s.score}</span>`; list.appendChild(li); });
}

function renderBindingsUI(){
  const cont=$('#bindList'); cont.innerHTML='';
  const g=gameState.game; const entries=Object.entries(g.input.bindings);
  entries.forEach(([action,code])=>{
    const li=document.createElement('li');
    li.innerHTML = `<span>${action}</span><button class="btn right" data-action="${action}"><span class="kbd">${code}</span></button>`;
    cont.appendChild(li);
  });
  cont.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>beginRebind(btn.dataset.action,btn)));
}
let rebindResolver=null;
function beginRebind(action, btn){
  if (rebindResolver) return;
  const g=gameState.game;
  btn.innerHTML=`<span class="kbd">‚Ä¶ press a key ‚Ä¶</span>`;
  g.input.busyRebind=action;
  rebindResolver=(code)=>{
    if (Object.values(g.input.bindings).includes(code)){ toast('Key already in use'); return false; }
    g.input.setBinding(action,code);
    rebindResolver=null; g.input.busyRebind=null; renderBindingsUI(); return true;
  };
}
function rebindTryCapture(e){
  const g=gameState.game; if (!g || !g.input.busyRebind) return false;
  e.preventDefault(); const ok=rebindResolver?.(e.code); if (ok) toast(`Bound ${g.input.busyRebind} to ${e.code}`); return true;
}

function applyOptionsToUI(opt){
  $('#sfxVol').value=Math.round(opt.audio.sfx*100);
  $('#musVol').value=Math.round(opt.audio.music*100);
  $('#sfxVolLbl').textContent=Math.round(opt.audio.sfx*100)+'%';
  $('#musVolLbl').textContent=Math.round(opt.audio.music*100)+'%';
  $('#muteAll').checked=!!opt.audio.mute;

  $('#optParticles').checked=!!opt.gfx.particles;
  $('#optShake').checked=!!opt.gfx.shake;
  $('#optStars').value=opt.gfx.stars;
  $('#optReduce').checked=!!opt.gfx.reduce;
  $('#optBloom').checked=!!opt.gfx.bloom;

  $('#optDifficulty').value=opt.gameplay.difficulty;
  $('#optAutoFire').checked=!!opt.gameplay.autoFire;
  $('#optVibrate').checked=!!opt.gameplay.vibrate;

  renderBindingsUI();
}
function readOptionsFromUI(){
  const g=gameState.game, opt=g.opts;
  opt.audio.sfx=+$('#sfxVol').value/100; opt.audio.music=+$('#musVol').value/100; opt.audio.mute=$('#muteAll').checked;
  opt.gfx.particles=$('#optParticles').checked; opt.gfx.shake=$('#optShake').checked; opt.gfx.stars=$('#optStars').value; opt.gfx.reduce=$('#optReduce').checked; opt.gfx.bloom=$('#optBloom').checked;
  opt.gameplay.difficulty=$('#optDifficulty').value; opt.gameplay.autoFire=$('#optAutoFire').checked; opt.gameplay.vibrate=$('#optVibrate').checked;

  Store.set('gp_options',opt); Audio.setVolumes(opt.audio.sfx,opt.audio.music); Audio.setMute(opt.audio.mute);
  g.stars.setDensity(opt.gfx.stars);
  g.diff=DIFFICULTY[opt.gameplay.difficulty]||DIFFICULTY.normal;
  toast('Options saved');
}
$('#sfxVol').addEventListener('input', e=>$('#sfxVolLbl').textContent=e.target.value+'%');
$('#musVol').addEventListener('input', e=>$('#musVolLbl').textContent=e.target.value+'%');

/* Buttons */
$('#newGameBtn').addEventListener('click', startNewGame);
$('#continueBtn').addEventListener('click', continueGame);
$('#howBtn').addEventListener('click', ()=>showPanel('how'));
$('#howBack').addEventListener('click', ()=>showPanel('menu'));
$('#optionsBtn').addEventListener('click', ()=>showPanel('options'));
$('#optBack').addEventListener('click', ()=>{ applyOptionsToUI(gameState.game.opts); showPanel('menu'); });
$('#optSave').addEventListener('click', ()=>{ readOptionsFromUI(); });
$('#optDefaults').addEventListener('click', ()=>{
  const g=gameState.game; g.opts=JSON.parse(JSON.stringify(DEFAULT_OPTIONS)); g.input.bindings={...DEFAULT_OPTIONS.controls}; applyOptionsToUI(g.opts);
});
$('#leaderBtn').addEventListener('click', ()=>{ populateLeaderboard(); showPanel('leader'); });
$('#leaderBack').addEventListener('click', ()=>showPanel('menu'));
$('#leaderClear').addEventListener('click', ()=>{ Store.del('gp_scores'); populateLeaderboard(); toast('Cleared'); });
$('#creditsBtn').addEventListener('click', ()=>showPanel('credits'));
$('#creditsBack').addEventListener('click', ()=>showPanel('menu'));

$('#resumeBtn').addEventListener('click', ()=>{ gameState.game.togglePause(); $('#pauseOverlay').hidden=true; canvas.focus(); });
$('#restartBtn').addEventListener('click', ()=>{ $('#pauseOverlay').hidden=true; gameState.game.start(true); canvas.focus(); });
$('#toMenuBtn').addEventListener('click', ()=>{
  $('#pauseOverlay').hidden=true; gameState.game.running=false; showPanel('menu');
  gameState.game.saveSnapshot(); refreshMenuStatus();
});

$('#gameOverMenuBtn').addEventListener('click', ()=>{
  $('#gameOverOverlay').hidden=true; showPanel('menu'); refreshMenuStatus();
});
$('#saveScoreBtn').addEventListener('click', ()=>{
  const name=($('#playerName').value||'Pilot').trim().slice(0,16);
  const score=gameState.game.score; const arr=Store.get('gp_scores',[]); arr.push({name,score,when:Date.now()});
  Store.set('gp_scores',arr); $('#gameOverOverlay').hidden=true; populateLeaderboard(); showPanel('leader');
});

/* Misc */
function toggleFullscreen(){ const doc=document, el=document.documentElement; if (!doc.fullscreenElement){ el.requestFullscreen?.().catch(()=>{}); } else { doc.exitFullscreen?.(); } }
function startNewGame(){ hideAllPanels(); $('#pauseOverlay').hidden=true; $('#gameOverOverlay').hidden=true; gameState.game.start(true); canvas.focus(); }
function continueGame(){ hideAllPanels(); gameState.game.loadSave(); gameState.game.start(false); canvas.focus(); }

/* Boot */
document.getElementById('bootBtn').addEventListener('click', ()=>{
  Audio.init(); Audio.resume();
  document.getElementById('boot').style.display='none';
  initGame();
});
window.addEventListener('keydown', e=>{
  const g=gameState.game; if (!g) return;
  if (e.code==='Escape' && g.running){ e.preventDefault(); g.togglePause(true); }
  if (e.code==='KeyF'){ e.preventDefault(); toggleFullscreen(); }
});
window.addEventListener('beforeunload', ()=>{
  const g=gameState.game; if (g?.running){ g.saveSnapshot(); }
});
window.addEventListener('blur', ()=>{
  const g=gameState.game; if (g?.running && !g.paused){ g.togglePause(true); g.saveSnapshot(); refreshMenuStatus(); }
});

function initGame(){
  resizeCanvas();
  const savedOpt=Store.get('gp_options',DEFAULT_OPTIONS);
  const options=JSON.parse(JSON.stringify(DEFAULT_OPTIONS));
  for(const k in savedOpt){ if (typeof savedOpt[k]==='object') Object.assign(options[k],savedOpt[k]); else options[k]=savedOpt[k]; }
  const game=new Game(options); gameState.game=game;
  applyOptionsToUI(options); Audio.setVolumes(options.audio.sfx,options.audio.music); Audio.setMute(options.audio.mute);
  refreshMenuStatus(); showPanel('menu'); if (game.hasSave()) game.loadSave();
  if (!rafId) rafId=requestAnimationFrame(gameLoop);
}

/* Kickoff */
resizeCanvas();
paintBootBG();
/* Safety: keep overlays hidden on load */
document.getElementById('pauseOverlay').hidden=true;
document.getElementById('gameOverOverlay').hidden=true;
/* Canvas focus hint */
canvas.addEventListener('pointerdown', ()=> canvas.focus());

})(); // IIFE end
</script>
</body>
</html>
