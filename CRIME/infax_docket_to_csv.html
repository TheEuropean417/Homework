<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infax Docket → Spreadsheet (MO-Greene)</title>
  <style>
    :root { --bg:#0b1220; --fg:#e8eef7; --muted:#a9b4c4; --accent:#6cc04a; --accent2:#0ea5e9; --card:#121a2b; --border:#26324a;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    header{padding:28px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f172a 0%, #0c1324 100%);}
    header h1{margin:0;font-size:22px}
    header p{margin:6px 0 0;color:var(--muted)}
    main{max-width:960px;margin:0 auto;padding:24px 20px 48px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin:18px 0}
    .card h2{margin:0 0 12px;font-size:18px}
    .steps ol{margin:0;padding-left:20px}
    a.bm, a.primary{display:inline-block;background:var(--accent);color:#0b120f;text-decoration:none;font-weight:700;padding:12px 16px;border-radius:10px;box-shadow:0 2px 0 rgba(0,0,0,.25);}
    a.primary{background:var(--accent2);color:#fff}
    a.bm:hover, a.primary:hover{filter:brightness(0.95)}
    code, pre, textarea{background:#0f172a;border:1px solid var(--border);border-radius:10px;color:var(--fg);}
    textarea{width:100%;min-height:220px;padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .muted{color:var(--muted)}
    footer{padding:18px 20px;border-top:1px solid var(--border);color:var(--muted)}
    .small{font-size:13px}
    .cta{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:.25rem .6rem;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .url{word-break:break-all}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:740px){.grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Infax Docket → Spreadsheet (MO-Greene)</h1>
    <p class="small">Use one of the methods below (Edge extension, Favorite/Bookmarklet, or Console) to export the docket at <span class="url">https://infax.com/docket/MO-Greene/</span> to CSV.</p>
  </header>
  <main>
    <section class="card">
      <h2>Option A — Microsoft Edge extension (1-time setup, then automatic)</h2>
      <div class="grid">
        <div>
          <ol>
            <li>Install the tiny extension: <strong>edge-infax-export.zip</strong></li>
            <li>Open <strong>edge://extensions</strong> → turn on <em>Developer mode</em> → <em>Load unpacked</em> → select the unzipped folder.</li>
            <li>Click this to open the docket: <a class="primary" href="https://infax.com/docket/MO-Greene/" target="_blank" rel="noopener">Open MO–Greene docket</a></li>
          </ol>
          <p class="small muted">When the page loads, the extension adds a “Download CSV” button and will auto-download once the table appears.</p>
        </div>
        <div>
          <div class="cta">
            <span class="pill">Runs on that site</span>
            <span class="pill">Auto-download</span>
            <span class="pill">No external services</span>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Option B — Favorite (bookmarklet) — works in Edge too</h2>
      <ol>
        <li>Show the Favorites bar with <strong>Ctrl+Shift+B</strong> (or Settings → Appearance → <em>Show favorites bar</em> → Always).</li>
        <li>Drag this to your Favorites bar: <a id="bm" class="bm" href="#">Infax → CSV</a></li>
        <li>Go to <strong>https://infax.com/docket/MO-Greene/</strong> and click your new favorite.</li>
      </ol>
      <p class="small muted">Edge calls it the “Favorites bar.” The bookmarklet runs on the current page and saves the table as CSV.</p>
    </section>

    <section class="card">
      <h2>Option C — Run from the browser console</h2>
      <p class="small muted">Open the docket page, press <strong>F12</strong> (or <strong>Ctrl/Cmd + Shift + I</strong>) → Console, paste the script below, and press Enter.</p>
      <textarea id="console-snippet" readonly></textarea>
    </section>
  </main>
  <footer class="small">
    Built for exporting the Greene County (MO) docket displayed on Infax.
  </footer>

  <script>
  // Pretty, readable script (also used for Option C)
  const CONSOLE_SNIPPET = `(function(){
  function s(t){return (t||'').replace(/\\s+/g,' ').trim()}
  function visible(el){
    try{
      const cs = getComputedStyle(el);
      if(!cs || cs.display==='none' || cs.visibility==='hidden') return false;
      if(el.offsetParent===null && cs.position!=='fixed') return false;
      return true;
    }catch(e){ return true; }
  }
  function toCSV(aoa){
    return aoa.map(r => r.map(c => {
      const x = (c==null?'':(''+c)).replace(/\\r?\\n|\\r/g,' ').replace(/\"/g,'\"\"');
      return /[\",\\t]/.test(x) ? '\"'+x+'\"' : x;
    }).join(',')).join('\\r\\n');
  }

  // Try to detect the docket table NOW
  function findTableNow(){
    const wanted = ['Case Name','Party Name','Case Number','Floor','Courtroom','Hearing Time','Start Time','Case Type','Judge','Room'];
    const sWanted = wanted.map(w => w.toLowerCase());

    const tables = Array.from(document.querySelectorAll('table')).filter(visible);
    let table = tables.find(t => {
      const ht = s((t.tHead && t.tHead.textContent) || (t.querySelector('thead') && t.querySelector('thead').textContent) || (t.rows[0] && t.rows[0].textContent) || '');
      return sWanted.some(k => ht.toLowerCase().includes(k));
    }) || (tables[0] || null);

    let headers = [], rows = [];
    if(table){
      const ths = table.querySelectorAll('thead th, thead td');
      if(ths.length){
        headers = Array.from(ths).map(th => s(th.textContent));
      }else{
        const fr = table.querySelector('tr');
        if(fr) headers = Array.from(fr.cells).map(c => s(c.textContent));
      }
      const bodyRows = table.querySelectorAll('tbody tr');
      const trs = bodyRows.length ? bodyRows : Array.from(table.querySelectorAll('tr')).slice(headers.length?1:0);
      rows = Array.from(trs).filter(visible).map(tr => Array.from(tr.cells).map(td => s(td.textContent)));
    }else{
      // ARIA table/grid fallback
      const aria = document.querySelector('[role="table"], [role="grid"]');
      if(!aria) return null; // not ready yet
      headers = Array.from(aria.querySelectorAll('[role="columnheader"]')).map(c => s(c.textContent));
      rows = Array.from(aria.querySelectorAll('[role="row"]'))
        .filter(r => r.querySelector('[role="cell"]'))
        .map(r => Array.from(r.querySelectorAll('[role="cell"]')).map(c => s(c.textContent)));
    }

    if(rows.length && headers.length && rows[0].join('|')===headers.join('|')) rows.shift();
    if(!headers.length && rows.length) headers = rows[0].map((_,i) => 'Column '+(i+1));

    // Reduce to common subset if we can map at least a few known columns
    const hLower = headers.map(h => h.toLowerCase());
    const wanted = ['Case Name','Party Name','Case Number','Floor','Courtroom','Hearing Time','Start Time','Case Type','Judge','Room'];
    const idx = wanted.map(n => hLower.indexOf(n.toLowerCase())).filter(i => i>-1);

    let H = headers, R = rows;
    if(idx.length >= 3){
      H = idx.map(i => headers[i]);
      R = rows.map(r => idx.map(i => r[i] || ''));
    }

    return { H, R };
  }

  // Wait up to maxMs for table to appear (poll + MutationObserver)
  function waitForData(maxMs=15000){
    return new Promise((resolve, reject) => {
      const deadline = Date.now() + maxMs;

      const tryNow = () => {
        const res = findTableNow();
        if(res && res.R && res.R.length){ cleanup(); return resolve(res); }
        if(Date.now() > deadline){ cleanup(); return reject(new Error('Could not find docket rows on the page.')); }
      };

      const mo = new MutationObserver(() => tryNow());
      mo.observe(document.documentElement || document.body, { subtree: true, childList: true });

      const timer = setInterval(tryNow, 400);
      const cleanup = () => { try{ mo.disconnect(); }catch(_){} clearInterval(timer); };

      // kick once now
      tryNow();
    });
  }

  function runExport(H, R){
    // Filters you requested:
    // 1) Keep only rows where Column A contains a comma
    let F = R;
    if (H.length >= 1) {
      F = F.filter(r => (r[0] || '').indexOf(',') !== -1);
    }
    // 2) Remove duplicates by Column B, keep first
    if (H.length >= 2) {
      const seenB = new Set();
      F = F.filter(r => {
        const key = (r[1] || '').replace(/\\s+/g,' ').trim().toLowerCase();
        if (seenB.has(key)) return false;
        seenB.add(key);
        return true;
      });
    }

    const data = [H].concat(F);
    const csv  = toCSV(data);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    const date = (new Date()).toISOString().slice(0,10);
    const title = (document.querySelector('h1,h2') && s(document.querySelector('h1,h2').textContent)) || (document.title || 'MO-Greene Docket');
    a.href = URL.createObjectURL(blob);
    a.download = title.replace(/[^A-Za-z0-9]+/g,' ').trim() + ' ' + date + '.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  }

  waitForData(15000).then(({H,R}) => {
    runExport(H,R);
  }).catch(err => {
    console.error('[Infax → CSV] Error:', err);
    alert('Infax → CSV: ' + err.message + '\\n\\nIf this keeps happening, try Option C (Console) on the page.');
  });
})();`;

  // Put pretty code into the textarea (Option C)
  document.getElementById('console-snippet').value = CONSOLE_SNIPPET;

  // Generate the bookmarklet (Option B)
  // We keep the IIFE and add "void 0" to avoid navigation side effects.
  // changes
  const bmCode = CONSOLE_SNIPPET
    .replace(/\n/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .replace(/\s*([{}();,:])\s*/g, '$1');

  document.getElementById('bm').setAttribute('href', 'javascript:' + bmCode + 'void 0;');
</script>